DBQuery.shellBatchSize = 500;
db.BankAccount.aggregate([{$match:{bankIdentifier:null, aggregatorName:'yodlee' }},
{
        $lookup: {
            from: 'Organisation',
            localField: 'organisationId',
            foreignField: '_id',
            as: 'org'
        }
    },
{ $unwind: '$org' },{ $unwind: '$org.products' },
{ $project: { productId: '$org.products.productId','bankIdentifier':'$bankIdentifier','accountIdentifier':'$accountIdentifier','status':'$status',
    'requestedStartDate':'$requestedStartDate','lastTransactionsReceived':'$lastTransactionsReceived','lastTransactionsGet':'$lastTransactionsGet','lastTransactionId':'$lastTransactionId','created':'$created'}},
{
        $lookup: {
            from: 'Product',
            localField: 'productId',
            foreignField: '_id',
            as: 'prod'
        }
    },
{ $unwind: '$prod' },
{$project:{'product':'$prod.name','bankIdentifier':'$bankIdentifier','accountIdentifier':'$accountIdentifier','status':'$status',
    'requestedStartDate':'$requestedStartDate','lastTransactionsReceived':'$lastTransactionsReceived','lastTransactionId':'$lastTransactionId','created':'$created'}},
{$sort:{'product': - 1, 'status': -1, 'created': -1}}])