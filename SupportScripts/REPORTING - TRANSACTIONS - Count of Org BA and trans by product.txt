db.Organisation.aggregate([
{ $unwind: { path: '$products', preserveNullAndEmptyArrays: false } },
{ $lookup: { from: 'Product', localField: 'products.productId', foreignField: '_id', as: 'prod'}},
{ $unwind: { path: '$bankAccounts', preserveNullAndEmptyArrays: false } },
{ $lookup: { from: 'Transaction', localField: 'bankAccounts.bankAccountId', foreignField: 'bankAccountId', as: 'transLookup'}},
{ $unwind: { path: '$transLookup', preserveNullAndEmptyArrays: false } },
{ $unwind: { path: '$transLookup.transactions', preserveNullAndEmptyArrays: false } },
{
        $project: {
            _id: '$products.productId',
            productName: '$prod.name',
            numberOfOrg: '$_id',
            numberOfBankAccounts: '$transLookup.bankAccountId',
            numberOfTrans: '$transLookup.transactions.uuid'
        }
    }, {
        $group: {
            _id: '$_id',
            productName: { $first: '$productName' },
            numberOfOrg: { $addToSet: '$numberOfOrg' },
            numberOfBankAccounts: { $addToSet: '$numberOfBankAccounts' },
            numberOfTrans: { $addToSet: '$numberOfTrans' },
        }
    },
{ $unwind: { path: '$productName', preserveNullAndEmptyArrays: false } },
{
        $project: {
            _id: 1,
            productName: 1,
            numberOfOrg: { $cond: [{ $not: ['$numberOfOrg'] }, 0, { $size: '$numberOfOrg'}] },
            numberOfBankAccounts: { $cond: [{ $not: ['$numberOfBankAccounts'] }, 0, { $size: '$numberOfBankAccounts'}] },
            numberOfTrans: { $cond: [{ $not: ['$numberOfTrans'] }, 0, { $size: '$numberOfTrans'}] }
        }
    }
],{
allowDiskUse: true
})